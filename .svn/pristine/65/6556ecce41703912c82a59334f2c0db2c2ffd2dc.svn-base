/**
 * SKIMP-FR-004.js
 * @ 간편인증
 * 2021.05.21
 */

var bioCertRstCd = "";
var fromWhere = '';

var pageInit = function(){

	//생체인증 가능 여부 체크
	fingerCheck();

	pageEvent();
};

var pageEvent = function(){

	//생체인증등록
	$(document).on('click', '#btnBio', function(){
		if(bioCertRstCd == "402"){
			M.pop.alert({
		        message: '디바에스에 등록된 생체인증 정보가 없습니다.\n[확인] 버튼을 누르시면 설정으로 이동합니다.',
		        buttons: ['확인', '취소'],
		        callback: function(idx) {
		        	if (idx == 0) {
		        		fromWhere = 'setBIO';
		        		
		        		//등록된 생체인증 정보가 없을 때, 설정 페이지로 이동
		    			if(M.navigator.device("ios")) {     // ios일 경우
		    		        var result = M.plugin('3rd_iOS_fingerprint_basic').moveSetting();
		    		        console.log('result : ' + JSON.stringify(result));
		    		    } else if (M.navigator.device("android")) {     // android일 경우
		    		        var result = M.plugin('3rd_fingerprint_basic').moveSetting();
		    		        console.log('result : ' + JSON.stringify(result));
		    		    }
		        	}
		        }
			});
		}else{
			bioCert.auth((status, result) => {
				console.log(status);
				if(status == "SUCCESS" && result.result == "SUCCESS"){
					MData.storage('lastLoginType', 'BIO');
					MData.storage('BioLoginData', 'Y');
					MData.storage('useEasyLogin', 'Y');
					Login();
				}else if(result.message == 'CANCEL' || result.errorCode == '10'){
//					MPopup.alert({
//						message : "생체 인증 등록을 취소하였습니다."
//					});
				}else if (result.errorCode == '406') {
					
				}else{
					MPopup.alert({
						message : "생체 인증 로그인에 실패했습니다."
					});
					MData.storage('useEasyLogin', 'N');
				}
			});
		}
	});

	//패턴인증 등록
	$(document).on('click', '#btnPattern', function(){
		ptCert.lock((status, result) => {
			console.log(status);
			console.log(result);
			if(result.message == "SUCCESS" || result.result == "SUCCESS"){
//				M.pop.alert('result : ' + JSON.stringify(result));
				MData.storage('lastLoginType', 'PATTERN');
				MData.storage('PatternLoginData', 'Y');
				MData.storage('useEasyLogin', 'Y');
				Login();
			}else if(result.message == 'CANCEL' || result.message == 'Canceled Pattern Editing.'){
//				MPopup.alert({
//					message : "패턴 인증 등록을 취소하였습니다."
//				});
			}else{
				MPopup.alert({
					message : "패턴이 틀렸습니다."
				});
				MData.storage('useEasyLogin', 'N');
			}
		});
	});

	//PIN 인증 등록
	$(document).on('click', '#btnPin', function(){
		pinCert.register((status, result) => {
			console.log(status);

			if(result.message == "SUCCESS" || result.result == "SUCCESS"){
				MData.storage('lastLoginType', 'PIN');
				MData.storage('PinLoginData', 'Y');
				MData.storage('useEasyLogin', 'Y');
				Login();
			}else if(result.message == 'CANCEL'){
//				MPopup.alert({
//					message : "PIN 인증 등록을 취소하였습니다."
//				});
			}else{
				MPopup.alert({
					message : "PIN 번호가 틀렸습니다."
				});
				MData.storage('useEasyLogin', 'N');
			}
		});
	});

	//건너뛰기 버튼
	$(document).on('click', '#btnNext', function(){
		Login();
	});
};


var Login = function(){
	//최초로그인 여부 저장
	MData.storage('firstLogin') == "N" ? "" : MData.storage('firstLogin', 'N');

	MPage.html({
		url : "SKIMP-FR-007.html",
		action : "CLEAR_TOP",
	})
}


var fingerCheck = function(){
	bioCert.check((status, result) => {
		console.log(status);
		if(status == "SUCCESS"){
			if(result.result != "SUCCESS"){
				bioCertRstCd = result.result_code;
			}else if(fromWhere == 'setBIO' && result.result == "SUCCESS"){
				fromWhere = '';

				MData.storage('lastLoginType', 'BIO');
				MData.storage('BioLoginData', 'Y');
				MData.storage('useEasyLogin', 'Y');
				Login();
			}
			$('#btnBio').removeClass('none');
		}else{
			$('#btnBio').addClass('none');
		}
	});
}


var MStatus = {
		onReady : function(){
			pageInit();
		},

//		onBack : function(){
//
//		},

		onRestore : function(){
			//현재화면에서 생체정보 등록후 다시 돌아왔을경우 체크
			fingerCheck();
		},

		onHide : function(){

		},

		onDestroy : function(){

		},

		onPause : function(){

		},

		onResume : function(){
			if (fromWhere == 'setBIO') {
				//생체인증 가능 여부 체크
				fingerCheck();
				
				console.log("onResume");
				loginAuth();
			}
		}
}