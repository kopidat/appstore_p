package skimp.partner.store;

import m.client.android.library.core.utils.Logger;
import m.client.android.library.core.utils.PLog;
import m.client.android.library.core.view.MainActivity;
import skimp.partner.store.common.Const;
import skimp.partner.store.common.Utils;
import skimp.partner.store.manager.InterfaceManager;
import skimp.partner.store.push.PushMessageManager;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.AlertDialog;
import android.app.admin.DevicePolicyManager;
import android.content.ComponentName;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.graphics.Bitmap;
import android.net.Uri;
import android.os.Bundle;
import android.text.TextUtils;
import android.util.Log;
import android.webkit.WebView;

import java.util.List;

/**
 * BaseActivity Class
 * 
 * @author 김태욱(<a mailto="tukim@uracle.co.kr">tukim@uracle.co.kr</a>)
 * @version v 1.0.0
 * @since Android 2.1 <br>
 *        <DT><B>Date: </B>
 *        <DD>2013.08.01</DD>
 *        <DT><B>Company: </B>
 *        <DD>Uracle Co., Ltd.</DD>
 * 
 * 모피어스 내에서 제공되는 모든 Web 페이지의 기본이 되는 Activity
 * html 화면은 모두 BaseActivity 상에서 출력된다.
 * 제어를 원하는 이벤트들은 overriding 하여 구현하며, 각각 페이지 별 이벤트는 화면 단위로 분기하여 처리한다.
 * 플랫폼 내부에서 사용하는 클래스로 해당 클래스의 이름은 변경할 수 없다.
 * 
 * Copyright (c) 2001-2011 Uracle Co., Ltd. 
 * 166 Samseong-dong, Gangnam-gu, Seoul, 135-090, Korea All Rights Reserved.
 */

public class BaseActivity extends MainActivity {
	private static final String TAG = BaseActivity.class.getSimpleName();

	private static final boolean sIsPassCheckMDMForDebug = false;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		PLog.i(TAG, "onCreate(Bundle savedInstanceState)");
		super.onCreate(savedInstanceState);
	}

	@Override
	protected void onResume() {
		super.onResume();

		// MDM 가이드준 메소드 사용해서 체크
		if(!sIsPassCheckMDMForDebug) {
			boolean isInstalled = checkMDM();
			if(!isInstalled) {
				goMDMInstallPage();
			}
		}

//		// MDM 설치 및 정책 ON 세부적으로 체크 및 안내팝업
//		if(!sIsPassCheckMDMForDebug) {
//			// 1. 설치확인
//			if(!isMDMInstalled()) {
//				showMDMInstallDialog();
//			}
//
//			// 2. 정책확인
//			if(!isMDMOn()) {
//				showMDMOnDialog();
//			}
//		}
	}

	/**
	 * Webview가 시작 될 때 호출되는 함수
	 */
	@Override
	public void onPageStarted (WebView view, String url, Bitmap favicon) {
		super.onPageStarted(view, url, favicon);
	}
	
	/**
	 * Webview내 컨텐츠가 로드되고 난 후 호출되는 함수
	 */
	@Override
	public void onPageFinished(WebView view, String url)  {
		super.onPageFinished(view, url);

		// 푸시 노티클릭으로 실행되었는지 체크
		PushMessageManager.checkStartFromPushNotiClick();
	}

	@Override
	public void onActivityResult(int requestCode, int resultCode, Intent data) {
		PLog.i(TAG, "onActivityResult(int requestCode, int resultCode, Intent data)");
		PLog.d(TAG, "requestCode = " + requestCode);
		PLog.d(TAG, "resultCode = " + resultCode);
		PLog.d(TAG, "data = " + data);

		Utils.debugIntent(TAG, data);

		if(data == null) return;

		super.onActivityResult(requestCode, resultCode, data);

		// 간편 인증
		if (requestCode == Const.REQ_AUTH_PIN) {
			Log.d("KDS", "result = "+data.getStringExtra("KEY_RESULT"));
			Log.d("KDS", "pin = "+data.getStringExtra("pin"));
			String result = data.getStringExtra("KEY_RESULT");
			String pin = data.getStringExtra("pin");
			String message = data.getStringExtra("message");
			JSONObject obj = new JSONObject();
			try {
				obj.put("result", result);
				obj.put("message", TextUtils.isEmpty(message)? result:message);
				if(!TextUtils.isEmpty(pin) || resultCode == Const.REQ_AUTH_PIN_GET)
					obj.put("pin", pin);
			} catch (JSONException e) {
				e.printStackTrace();
			}
			InterfaceManager.getInstance().loadUrl(this, Const.JS_PinAuthManager, result, obj);
		} else if (requestCode == Const.REQ_AUTH_PATTERN) {
			Log.d("KDS", "result = "+data.getStringExtra("KEY_RESULT"));
			Log.d("KDS", "KEY_CODE = "+data.getStringExtra("KEY_CODE"));
			String result = data.getStringExtra("KEY_RESULT");
			String KEY_CODE = data.getStringExtra("KEY_CODE");
			String message = data.getStringExtra("message");
			JSONObject obj = new JSONObject();
			try {
				obj.put("result", result);
				obj.put("message", TextUtils.isEmpty(message)? result:message);
				if(!TextUtils.isEmpty(KEY_CODE)) obj.put("KEY_CODE", KEY_CODE);
			} catch (JSONException e) {
				e.printStackTrace();
			}
			InterfaceManager.getInstance().loadUrl(this, Const.JS_PatternAuthManager, result, obj);
		}
	}

	private boolean checkMDM() {
		DevicePolicyManager devicePolicyManager = (DevicePolicyManager) getSystemService(Context.DEVICE_POLICY_SERVICE);
		List<ComponentName> activeAdmins = devicePolicyManager.getActiveAdmins();
		if (activeAdmins != null) {
			for (ComponentName admin : activeAdmins) {
				if (admin.getPackageName().compareTo("com.funnnew.android.skimds") == 0) {
					if (devicePolicyManager.getCameraDisabled(admin)) {
						return true;
					}
				}
			}
		}
		return false;
	}

	private boolean isMDMInstalled() {
		DevicePolicyManager devicePolicyManager = (DevicePolicyManager) getSystemService(Context.DEVICE_POLICY_SERVICE);
		List<ComponentName> activeAdmins = devicePolicyManager.getActiveAdmins();
		if (activeAdmins != null) {
			for (ComponentName admin : activeAdmins) {
				if (admin.getPackageName().compareTo("com.funnnew.android.skimds") == 0) {
					return true;
				}
			}
		}
		return false;
	}

	private boolean isMDMOn() {
		DevicePolicyManager devicePolicyManager = (DevicePolicyManager) getSystemService(Context.DEVICE_POLICY_SERVICE);
		List<ComponentName> activeAdmins = devicePolicyManager.getActiveAdmins();
		if (activeAdmins != null) {
			for (ComponentName admin : activeAdmins) {
				if (admin.getPackageName().compareTo("com.funnnew.android.skimds") == 0) {
					if (devicePolicyManager.getCameraDisabled(admin)) {
						return true;
					}
				}
			}
		}

		return false;
	}

	private void showMDMInstallDialog() {
		AlertDialog.Builder alertDialog = new AlertDialog.Builder(this);
		alertDialog.setTitle("알림");
		alertDialog.setMessage("보안앱(MDS)이 설치되지 않았습니다.\n설치 페이지로 이동합니다.");
		alertDialog.setNegativeButton("이동", new DialogInterface.OnClickListener() {
			@Override
			public void onClick(DialogInterface dialog, int which) {
				goMDMInstallPage();
				finish();
			}
		});

		alertDialog.show();
	}

    private void showMDMOnDialog() {
        AlertDialog.Builder alertDialog = new AlertDialog.Builder(this);
        alertDialog.setTitle("알림");
        alertDialog.setMessage("보안 OFF 상태입니다.\nON후 이용해주세요.");
        alertDialog.setNegativeButton("종료", new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                Intent intent_mds = getPackageManager().getLaunchIntentForPackage("com.funnnew.android.skimds");
                if (intent_mds != null) {
                    startActivity(intent_mds);
                }
                finish();
            }
        });

        alertDialog.show();
    }

	private void goMDMInstallPage() {
//        String url = "https://mds.skinnovation.com/downloads"; // 운영
		String url = "https://svr.funnnew.com:24005/downloads"; // 테스트
		Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));
		startActivity(intent);
	}

}
